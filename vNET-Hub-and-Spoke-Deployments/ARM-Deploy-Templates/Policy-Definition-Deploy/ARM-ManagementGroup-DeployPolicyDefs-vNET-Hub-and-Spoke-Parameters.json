{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentParameters.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "input1": {
            "value": {
                "mode": "All",
                "policyType": "Custom",
                "displayName": "Deploy-vNET-Hub",
                "description": "Deploy VNET Hub with Gateway",
                "metadata": {
                    "category": "Enterprise Landing Zone"
                },
                "policyRule": {
                    "if": {
                        "field": "type",
                        "equals": "Microsoft.Resources/subscriptions"
                    },
                    "then": {
                        "effect": "deployIfNotExists",
                        "details": {
                            "type": "Microsoft.Network/virtualNetworks",
                            "name": "[parameters('vnetName')]",
                            "ResourceGroupName": "[parameters('resourceGroupName')]",
                            "roleDefinitionIds": [
                                "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                            ],
                            "existenceScope": "ResourceGroup",
                            "deploymentScope": "Subscription",
                            "deployment": {
                                "location": "eastus",
                                "properties": {
                                    "mode": "incremental",
                                    "parameters": {
                                        "vnetName": {
                                            "value": "[parameters('vnetName')]"
                                        },
                                        "resourceGroupName": {
                                            "value": "[parameters('resourceGroupName')]"
                                        },
                                        "vnetAddressSpace": {
                                            "value": "[parameters('vnetAddressSpace')]"
                                        },
                                        "dnsServers": {
                                            "value": "[parameters('dnsServers')]"
                                        },
                                        "gatewaySubnetAddressPrefix": {
                                            "value": "[parameters('gatewaySubnetAddressPrefix')]"
                                        },
                                        "firewallSubnetAddressPrefix": {
                                            "value": "[parameters('firewallSubnetAddressPrefix')]"
                                        },
                                        "bastionSubnetAddressPrefix": {
                                            "value": "[parameters('bastionSubnetAddressPrefix')]"
                                        },
                                        "subnets": {
                                            "value": "[parameters('subnets')]"
                                        },
                                        "gatewayType": {
                                            "value": "[parameters('gatewayType')]"
                                        },
                                        "gatewaySku": {
                                            "value": "[parameters('gatewaySku')]"
                                        },
                                        "location": {
                                            "value": "[parameters('location')]"
                                        }
                                    },
                                    "template": {
                                        "$schema": "http://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json",
                                        "contentVersion": "1.0.0.0",
                                        "parameters": {
                                            "vnetName": {
                                                "type": "string"
                                            },
                                            "resourceGroupName": {
                                                "type": "string"
                                            },
                                            "vnetAddressSpace": {
                                                "type": "string"
                                            },
                                            "dnsServers": {
                                                "type": "array"
                                            },
                                            "gatewaySubnetAddressPrefix": {
                                                "type": "string"
                                            },
                                            "firewallSubnetAddressPrefix": {
                                                "type": "string"
                                            },
                                            "bastionSubnetAddressPrefix": {
                                                "type": "string"
                                            },
                                            "subnets": {
                                                "type": "array"
                                            },
                                            "gatewayType": {
                                                "type": "string",
                                                "allowedValues": [
                                                    "VPN",
                                                    "ExpressRoute"
                                                ]
                                            },
                                            "gatewaySku": {
                                                "type": "string"
                                            },
                                            "location": {
                                                "type": "string"
                                            }
                                        },
                                        "variables": {
                                            "subnets": {
                                                "copy": [
                                                    {
                                                        "name": "subnetArray",
                                                        "count": "[length(parameters('subnets'))]",
                                                        "input": {
                                                            "name": "[parameters('subnets')[copyIndex('subnetArray')].name]",
                                                            "properties": {
                                                                "addressPrefix": "[parameters('subnets')[copyIndex('subnetArray')].addressPrefix]",
                                                                "networkSecurityGroup": {
                                                                    "id": "[concat(subscription().id,'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Network/networkSecurityGroups/NSG_',parameters('subnets')[copyIndex('subnetArray')].name,'_',parameters('location'))]"
                                                                }
                                                            }
                                                        }
                                                    }
                                                ]
                                            },
                                            "GatewaySubnet": {
                                                "name": "GatewaySubnet",
                                                "properties": {
                                                    "addressPrefix": "[parameters('gatewaySubnetAddressPrefix')]"
                                                }
                                            },
                                            "FirewallSubnet": {
                                                "name": "AzureFirewallSubnet",
                                                "properties": {
                                                    "addressPrefix": "[parameters('firewallSubnetAddressPrefix')]"
                                                }
                                            },
                                            "Bastion": {
                                                "name": "AzureBastionSubnet",
                                                "properties": {
                                                    "addressPrefix": "[parameters('bastionSubnetAddressPrefix')]"
                                                }
                                            },
                                            "finalSubnetArray": "[if(and(equals(parameters('firewallSubnetAddressPrefix'),''),equals(parameters('bastionSubnetAddressPrefix'),'')),concat(variables('subnets').subnetArray,array(variables('GatewaySubnet'))),if(and(not(empty(parameters('firewallSubnetAddressPrefix'))),equals(parameters('bastionSubnetAddressPrefix'),'')),concat(variables('subnets').subnetArray,array(variables('GatewaySubnet')),array(variables('FirewallSubnet'))),if(and(not(empty(parameters('bastionSubnetAddressPrefix'))),equals(parameters('firewallSubnetAddressPrefix'),'')),concat(variables('subnets').subnetArray,array(variables('GatewaySubnet')),array(variables('Bastion'))),if(and(not(empty(parameters('bastionSubnetAddressPrefix'))),not(empty(parameters('firewallSubnetAddressPrefix')))),concat(variables('subnets').subnetArray,array(variables('GatewaySubnet')),array(variables('Bastion')),array(variables('FirewallSubnet'))),concat(variables('subnets').subnetArray,array(variables('GatewaySubnet')))))))]",
                                            "vpnGatewayProperties": {
                                                "ipConfigurations": [
                                                    {
                                                        "properties": {
                                                            "privateIPAllocationMethod": "Dynamic",
                                                            "subnet": {
                                                                "id": "[concat(subscription().id,'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Network/virtualNetworks/',parameters('vnetName'),'/subnets/GatewaySubnet')]"
                                                            },
                                                            "publicIPAddress": {
                                                                "id": "[concat(subscription().id,'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Network/publicIPAddresses/',concat(parameters('location'),'-gw-pip'))]"
                                                            }
                                                        },
                                                        "name": "ipConfig"
                                                    }
                                                ],
                                                "gatewayType": "VPN",
                                                "vpnType": "RouteBased",
                                                "sku": {
                                                    "name": "[parameters('gatewaySku')]",
                                                    "tier": "[parameters('gatewaySku')]"
                                                }
                                            },
                                            "erGatewayProperties": {
                                                "ipConfigurations": [
                                                    {
                                                        "properties": {
                                                            "privateIPAllocationMethod": "Dynamic",
                                                            "subnet": {
                                                                "id": "[concat(subscription().id,'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Network/virtualNetworks/',parameters('vnetName'),'/subnets/GatewaySubnet')]"
                                                            },
                                                            "publicIPAddress": {
                                                                "id": "[concat(subscription().id,'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Network/publicIPAddresses/',concat(parameters('location'),'-gw-pip'))]"
                                                            }
                                                        },
                                                        "name": "ipConfig"
                                                    }
                                                ],
                                                "gatewayType": "ExpressRoute",
                                                "sku": {
                                                    "name": "[parameters('gatewaySku')]",
                                                    "tier": "[parameters('gatewaySku')]"
                                                }
                                            }
                                        },
                                        "resources": [
                                            {
                                                "type": "Microsoft.Resources/resourceGroups",
                                                "apiVersion": "2018-05-01",
                                                "name": "[parameters('resourceGroupName')]",
                                                "location": "[parameters('location')]",
                                                "properties": {}
                                            },
                                            {
                                                "type": "Microsoft.Resources/deployments",
                                                "apiVersion": "2018-05-01",
                                                "name": "[concat(parameters('vnetName'),'-',parameters('location'),'-Bastion')]",
                                                "condition": "[not(empty(parameters('bastionSubnetAddressPrefix')))]",
                                                "resourceGroup": "[parameters('resourceGroupName')]",
                                                "dependsOn": [
                                                    "[concat(parameters('vnetName'),'-',parameters('location'))]"
                                                ],
                                                "properties": {
                                                    "mode": "incremental",
                                                    "template": {
                                                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                        "contentVersion": "1.0.0.0",
                                                        "parameters": {},
                                                        "variables": {},
                                                        "resources": [
                                                            {
                                                                "name": "[concat(parameters('location'),'-bastion-pip')]",
                                                                "type": "Microsoft.Network/publicIPAddresses",
                                                                "apiVersion": "2020-05-01",
                                                                "location": "[parameters('location')]",
                                                                "sku": {
                                                                    "name": "standard"
                                                                },
                                                                "properties": {
                                                                    "publicIPAllocationMethod": "Static"
                                                                }
                                                            },
                                                            {
                                                                "name": "[concat('bastion-', parameters('location'))]",
                                                                "type": "Microsoft.Network/bastionHosts",
                                                                "apiVersion": "2020-05-01",
                                                                "location": "[parameters('location')]",
                                                                "tags": {},
                                                                "properties": {
                                                                    "ipConfigurations": [
                                                                        {
                                                                            "properties": {
                                                                                "subnet": {
                                                                                    "id": "[concat(subscription().id,'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Network/virtualNetworks/',parameters('vnetName'),'/subnets/AzureBastionSubnet')]"
                                                                                },
                                                                                "publicIPAddress": {
                                                                                    "id": "[concat(subscription().id,'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Network/publicIPAddresses/',concat(parameters('location'),'-bastion-pip'))]"
                                                                                }
                                                                            },
                                                                            "name": "ipconfig"
                                                                        }
                                                                    ]
                                                                }
                                                            }
                                                        ]
                                                    }
                                                }
                                            },
                                            {
                                                "type": "Microsoft.Resources/deployments",
                                                "apiVersion": "2018-05-01",
                                                "name": "[concat(parameters('vnetName'),'-',parameters('location'),'-Firewall')]",
                                                "condition": "[not(empty(parameters('firewallSubnetAddressPrefix')))]",
                                                "resourceGroup": "[parameters('resourceGroupName')]",
                                                "dependsOn": [
                                                    "[concat(parameters('vnetName'),'-',parameters('location'))]"
                                                ],
                                                "properties": {
                                                    "mode": "incremental",
                                                    "template": {
                                                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                        "contentVersion": "1.0.0.0",
                                                        "parameters": {},
                                                        "variables": {},
                                                        "resources": [
                                                            {
                                                                "name": "[concat(parameters('location'),'-fw-pip')]",
                                                                "type": "Microsoft.Network/publicIPAddresses",
                                                                "apiVersion": "2020-05-01",
                                                                "location": "[parameters('location')]",
                                                                "sku": {
                                                                    "name": "standard"
                                                                },
                                                                "properties": {
                                                                    "publicIPAllocationMethod": "Static"
                                                                }
                                                            },
                                                            {
                                                                "name": "[concat('firewall-',parameters('location'))]",
                                                                "type": "Microsoft.Network/azureFirewalls",
                                                                "apiVersion": "2020-05-01",
                                                                "location": "[parameters('location')]",
                                                                "dependsOn": [
                                                                    "[concat(parameters('location'),'-fw-pip')]"
                                                                ],
                                                                "properties": {
                                                                    "ipConfigurations": [
                                                                        {
                                                                            "properties": {
                                                                                "subnet": {
                                                                                    "id": "[concat(subscription().id,'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Network/virtualNetworks/',parameters('vnetName'),'/subnets/AzureFirewallSubnet')]"
                                                                                },
                                                                                "publicIPAddress": {
                                                                                    "id": "[concat(subscription().id,'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Network/publicIPAddresses/',concat(parameters('location'),'-fw-pip'))]"
                                                                                }
                                                                            },
                                                                            "name": "ipconfig"
                                                                        }
                                                                    ]
                                                                }
                                                            }
                                                        ]
                                                    }
                                                }
                                            },
                                            {
                                                "type": "Microsoft.Resources/deployments",
                                                "apiVersion": "2018-05-01",
                                                "name": "[concat(parameters('vnetName'),'-',parameters('location'),'-Gateway')]",
                                                "condition": "[not(empty(parameters('gatewaySubnetAddressPrefix')))]",
                                                "resourceGroup": "[parameters('resourceGroupName')]",
                                                "dependsOn": [
                                                    "[concat(parameters('vnetName'),'-',parameters('location'))]"
                                                ],
                                                "properties": {
                                                    "mode": "incremental",
                                                    "template": {
                                                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                        "contentVersion": "1.0.0.0",
                                                        "parameters": {},
                                                        "variables": {},
                                                        "resources": [
                                                            {
                                                                "name": "[concat(parameters('location'),'-gw')]",
                                                                "type": "Microsoft.Network/virtualNetworkGateways",
                                                                "apiVersion": "2020-05-01",
                                                                "location": "[parameters('location')]",
                                                                "dependsOn": [
                                                                    "[concat(parameters('location'),'-gw-pip')]"
                                                                ],
                                                                "properties": "[if(equals(parameters('gatewayType'),'VPN'),variables('vpnGatewayProperties'),variables('erGatewayProperties'))]"
                                                            },
                                                            {
                                                                "name": "[concat(parameters('location'),'-gw-pip')]",
                                                                "type": "Microsoft.Network/publicIPAddresses",
                                                                "apiVersion": "2020-05-01",
                                                                "location": "[parameters('location')]",
                                                                "sku": {
                                                                    "name": "basic"
                                                                },
                                                                "properties": {
                                                                    "publicIPAllocationMethod": "Dynamic"
                                                                }
                                                            }
                                                        ]
                                                    }
                                                }
                                            },
                                            {
                                                "type": "Microsoft.Resources/deployments",
                                                "apiVersion": "2018-05-01",
                                                "name": "[concat(parameters('vnetName'),'-',parameters('location'),'-nsg-',copyIndex())]",
                                                "resourceGroup": "[parameters('resourceGroupName')]",
                                                "dependsOn": [
                                                    "[parameters('resourceGroupName')]"
                                                ],
                                                "copy": {
                                                    "name": "iterator",
                                                    "count": "[length(parameters('subnets'))]"
                                                },
                                                "properties": {
                                                    "mode": "incremental",
                                                    "template": {
                                                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                        "contentVersion": "1.0.0.0",
                                                        "parameters": {},
                                                        "variables": {},
                                                        "resources": [
                                                            {
                                                                "name": "[concat('NSG_',parameters('subnets')[copyIndex()].name,'_',parameters('location'))]",
                                                                "type": "Microsoft.Network/networkSecurityGroups",
                                                                "apiVersion": "2020-05-01",
                                                                "location": "[parameters('location')]",
                                                                "properties": {
                                                                    "securityRules": []
                                                                }
                                                            }
                                                        ],
                                                        "outputs": {
                                                            "nsgResourceId": {
                                                                "type": "string",
                                                                "value": "[resourceId('Microsoft.Network/networkSecurityGroups',concat('NSG_',parameters('subnets')[copyIndex()].name))]"
                                                            }
                                                        }
                                                    }
                                                }
                                            },
                                            {
                                                "type": "Microsoft.Resources/deployments",
                                                "apiVersion": "2018-05-01",
                                                "name": "[concat(parameters('vnetName'),'-',parameters('location'))]",
                                                "resourceGroup": "[parameters('resourceGroupName')]",
                                                "dependsOn": [
                                                    "[concat(parameters('vnetName'),'-',parameters('location'),'-nsg-',sub(length(parameters('subnets')),1))]"
                                                ],
                                                "properties": {
                                                    "mode": "incremental",
                                                    "template": {
                                                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                        "contentVersion": "1.0.0.0",
                                                        "parameters": {},
                                                        "variables": {},
                                                        "resources": [
                                                            {
                                                                "type": "Microsoft.Network/virtualNetworks",
                                                                "name": "[parameters('vnetName')]",
                                                                "apiVersion": "2020-05-01",
                                                                "location": "[parameters('location')]",
                                                                "properties": {
                                                                    "addressSpace": {
                                                                        "addressPrefixes": [
                                                                            "[parameters('vnetAddressSpace')]"
                                                                        ]
                                                                    },
                                                                    "dhcpOptions": {
                                                                        "dnsServers": "[parameters('dnsServers')]"
                                                                    },
                                                                    "subnets": "[variables('finalSubnetArray')]"
                                                                }
                                                            }
                                                        ]
                                                    }
                                                }
                                            }
                                        ]
                                    }
                                }
                            }
                        }
                    }
                },
                "parameters": {
                    "vnetName": {
                        "type": "String",
                        "metadata": {
                            "description": "The VNET name of your Spoke"
                        }
                    },
                    "resourceGroupName": {
                        "type": "String",
                        "metadata": {
                            "description": "The Resource Group Name that the Spoke VNET will be deployed to."
                        }
                    },
                    "vnetAddressSpace": {
                        "type": "String",
                        "metadata": {
                            "description": "The IPv4 Address Space for the Spoke VNET. Ex: \"10.10.0.0/22\""
                        }
                    },
                    "dnsServers": {
                        "type": "Array",
                        "defaultValue": [],
                        "metadata": {
                            "description": "Arrary of DNS Service IPs if wanting to use Custom DNS.  Ex: [\"10.10.1.1\",\"10.10.1.2\"]"
                        }
                    },
                    "gatewaySubnetAddressPrefix": {
                        "type": "String",
                        "metadata": {
                            "description": "Subnet address space for the VPN/Express Route Gateway. Ex: \"10.0.3.224/27\""
                        }
                    },
                    "firewallSubnetAddressPrefix": {
                        "type": "string",
                        "metadata": {
                            "description": "Leave Empty if you don't want to deploy. Subnet address space for an Azure Firewall. Ex: \"10.0.3.0/25\""
                        },
                        "defaultValue": ""
                    },
                    "bastionSubnetAddressPrefix": {
                        "type": "string",
                        "metadata": {
                            "description": "Leave Empty if you don't want to deploy. Subnet address space for an Azure Bastion Host. Ex: \"10.0.3.192/27\""
                        },
                        "defaultValue": ""
                    },
                    "subnets": {
                        "type": "Array",
                        "metadata": {
                            "description": "Names and address spaces of your Subnets.  Objects need a Name and Address Preffix property Ex: [{\"name\": \"subnet1\",\"addressPrefix\":\"10.10.0.0/24\"},{\"name\": \"subnet2\",\"addressPrefix\":\"10.10.1.0/24\"}]"
                        },
                        "defaultValue": []
                    },
                    "gatewayType": {
                        "type": "String",
                        "allowedValues": [
                            "VPN",
                            "ExpressRoute"
                        ],
                        "defaultValue": "VPN",
                        "metadata": {
                            "description": "Azure Gateway type. VPN or ExpressRoute"
                        }
                    },
                    "gatewaySku": {
                        "type": "String",
                        "allowedValues": [
                            "Basic",
                            "HighPerformance",
                            "Standard",
                            "UltraPerformance",
                            "VpnGw1",
                            "VpnGw2",
                            "VpnGw3",
                            "VpnGw4",
                            "VpnGw5"
                        ],
                        "defaultValue": "Standard",
                        "metadata": {
                            "description": "Azure Gateway Sku. Currently, this template does not support Availability Zone Gateway SKUs"
                        }
                    },
                    "location": {
                        "type": "String",
                        "metadata": {
                            "description": "Azure Region that VNET will be deployed to. Ex: eastus"
                        }
                    }
                }
            }
        },
        "input2": {
            "value": {
                "mode": "All",
                "policyType": "Custom",
                "displayName": "Deploy-vNET-Spoke",
                "description": "Deploy VNET Spoke with HUB peering",
                "metadata": {
                    "category": "Enterprise Landing Zone"
                },
                "policyRule": {
                    "if": {
                        "field": "type",
                        "equals": "Microsoft.Resources/subscriptions"
                    },
                    "then": {
                        "effect": "deployIfNotExists",
                        "details": {
                            "type": "Microsoft.Network/virtualNetworks",
                            "name": "[parameters('vnetName')]",
                            "ResourceGroupName": "[parameters('resourceGroupName')]",
                            "roleDefinitionIds": [
                                "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                            ],
                            "existenceScope": "ResourceGroup",
                            "deploymentScope": "Subscription",
                            "deployment": {
                                "location": "eastus",
                                "properties": {
                                    "mode": "incremental",
                                    "parameters": {
                                        "vnetName": {
                                            "value": "[parameters('vnetName')]"
                                        },
                                        "resourceGroupName": {
                                            "value": "[parameters('resourceGroupName')]"
                                        },
                                        "vnetAddressSpace": {
                                            "value": "[parameters('vnetAddressSpace')]"
                                        },
                                        "dnsServers": {
                                            "value": "[parameters('dnsServers')]"
                                        },
                                        "subnets": {
                                            "value": "[parameters('subnets')]"
                                        },
                                        "hubVnetId": {
                                            "value": "[parameters('hubVnetId')]"
                                        },
                                        "location": {
                                            "value": "[parameters('location')]"
                                        }
                                    },
                                    "template": {
                                        "$schema": "http://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json",
                                        "contentVersion": "1.0.0.0",
                                        "parameters": {
                                            "vnetName": {
                                                "type": "string"
                                            },
                                            "resourceGroupName": {
                                                "type": "string"
                                            },
                                            "vnetAddressSpace": {
                                                "type": "string"
                                            },
                                            "dnsServers": {
                                                "type": "array"
                                            },
                                            "subnets": {
                                                "type": "array"
                                            },
                                            "hubVnetId": {
                                                "type": "string"
                                            },
                                            "location": {
                                                "type": "string"
                                            }
                                        },
                                        "variables": {
                                            "subnets": {
                                                "copy": [
                                                    {
                                                        "name": "subnetArray",
                                                        "count": "[length(parameters('subnets'))]",
                                                        "input": {
                                                            "name": "[parameters('subnets')[copyIndex('subnetArray')].name]",
                                                            "properties": {
                                                                "addressPrefix": "[parameters('subnets')[copyIndex('subnetArray')].addressPrefix]",
                                                                "networkSecurityGroup": {
                                                                    "id": "[concat(subscription().id,'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Network/networkSecurityGroups/NSG_',parameters('subnets')[copyIndex('subnetArray')].name,'_',parameters('location'))]"
                                                                }
                                                            }
                                                        }
                                                    }
                                                ]
                                            },
                                            "subscriptionId": "[subscription().id]"
                                        },
                                        "resources": [
                                            {
                                                "type": "Microsoft.Resources/resourceGroups",
                                                "apiVersion": "2018-05-01",
                                                "name": "[parameters('resourceGroupName')]",
                                                "location": "[parameters('location')]",
                                                "properties": {}
                                            },
                                            {
                                                "type": "Microsoft.Resources/deployments",
                                                "apiVersion": "2018-05-01",
                                                "name": "[concat(parameters('vnetName'),'-',parameters('location'),'-nsg-',copyIndex())]",
                                                "resourceGroup": "[parameters('resourceGroupName')]",
                                                "dependsOn": [
                                                    "[parameters('resourceGroupName')]"
                                                ],
                                                "copy": {
                                                    "name": "iterator",
                                                    "count": "[length(parameters('subnets'))]"
                                                },
                                                "properties": {
                                                    "mode": "incremental",
                                                    "template": {
                                                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                        "contentVersion": "1.0.0.0",
                                                        "parameters": {},
                                                        "variables": {},
                                                        "resources": [
                                                            {
                                                                "name": "[concat('NSG_',parameters('subnets')[copyIndex()].name,'_',parameters('location'))]",
                                                                "type": "Microsoft.Network/networkSecurityGroups",
                                                                "apiVersion": "2020-05-01",
                                                                "location": "[parameters('location')]",
                                                                "properties": {
                                                                    "securityRules": []
                                                                }
                                                            }
                                                        ],
                                                        "outputs": {
                                                            "nsgResourceId": {
                                                                "type": "string",
                                                                "value": "[resourceId('Microsoft.Network/networkSecurityGroups',concat('NSG_',parameters('subnets')[copyIndex()].name))]"
                                                            }
                                                        }
                                                    }
                                                }
                                            },
                                            {
                                                "type": "Microsoft.Resources/deployments",
                                                "apiVersion": "2018-05-01",
                                                "name": "[concat(parameters('vnetName'),'-',parameters('location'))]",
                                                "resourceGroup": "[parameters('resourceGroupName')]",
                                                "dependsOn": [
                                                    "[concat(parameters('vnetName'),'-',parameters('location'),'-nsg-',sub(length(parameters('subnets')),1))]"
                                                ],
                                                "properties": {
                                                    "mode": "incremental",
                                                    "template": {
                                                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                        "contentVersion": "1.0.0.0",
                                                        "parameters": {},
                                                        "variables": {},
                                                        "resources": [
                                                            {
                                                                "type": "Microsoft.Network/virtualNetworks",
                                                                "name": "[parameters('vnetName')]",
                                                                "apiVersion": "2020-05-01",
                                                                "location": "[parameters('location')]",
                                                                "properties": {
                                                                    "addressSpace": {
                                                                        "addressPrefixes": [
                                                                            "[parameters('vnetAddressSpace')]"
                                                                        ]
                                                                    },
                                                                    "dhcpOptions": {
                                                                        "dnsServers": "[parameters('dnsServers')]"
                                                                    },
                                                                    "subnets": "[variables('subnets').subnetArray]"
                                                                }
                                                            },
                                                            {
                                                                "name": "[concat(parameters('vnetName'),'/To-HUB')]",
                                                                "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                                                                "apiVersion": "2020-05-01",
                                                                "properties": {
                                                                    "allowVirtualNetworkAccess": true,
                                                                    "allowForwardedTraffic": true,
                                                                    "useRemoteGateways": true,
                                                                    "remoteVirtualNetwork": {
                                                                        "id": "[parameters('hubVnetId')]"
                                                                    }
                                                                },
                                                                "dependsOn": [
                                                                    "[parameters('vnetName')]"
                                                                ]
                                                            },
                                                            {
                                                                "type": "Microsoft.Resources/deployments",
                                                                "apiVersion": "2018-05-01",
                                                                "name": "[concat(parameters('vnetName'),'-',parameters('location'),'-HubPeer')]",
                                                                "resourceGroup": "[split(parameters('hubVnetId'),'/')[4]]",
                                                                "subscriptionId": "[split(parameters('hubVnetId'),'/')[2]]",
                                                                "dependsOn": [
                                                                    "[parameters('vnetName')]"
                                                                ],
                                                                "properties": {
                                                                    "mode": "incremental",
                                                                    "template": {
                                                                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                                        "contentVersion": "1.0.0.0",
                                                                        "parameters": {},
                                                                        "variables": {},
                                                                        "resources": [
                                                                            {
                                                                                "name": "[concat(split(parameters('hubVnetId'),'/')[8],'/To-',parameters('vnetName'))]",
                                                                                "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                                                                                "apiVersion": "2020-05-01",
                                                                                "properties": {
                                                                                    "allowVirtualNetworkAccess": true,
                                                                                    "allowForwardedTraffic": false,
                                                                                    "allowGatewayTransit": true,
                                                                                    "remoteVirtualNetwork": {
                                                                                        "id": "[concat(variables('subscriptionId'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Network/virtualNetworks/',parameters('vnetName'))]"
                                                                                    }
                                                                                }
                                                                            }
                                                                        ]
                                                                    }
                                                                }
                                                            }
                                                        ],
                                                        "outputs": {
                                                            "vnetId": {
                                                                "type": "string",
                                                                "value": "[concat(subscription().id,'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Network/virtualNetworks/',parameters('vnetName'))]"
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        ]
                                    }
                                }
                            }
                        }
                    }
                },
                "parameters": {
                    "vnetName": {
                        "type": "String",
                        "metadata": {
                            "description": "The VNET name of your Spoke"
                        }
                    },
                    "resourceGroupName": {
                        "type": "String",
                        "metadata": {
                            "description": "The Resource Group Name that the Spoke VNET will be deployed to."
                        }
                    },
                    "vnetAddressSpace": {
                        "type": "String",
                        "metadata": {
                            "description": "The IPv4 Address Space for the Spoke VNET. Ex: \"10.10.0.0/22\""
                        }
                    },
                    "dnsServers": {
                        "type": "Array",
                        "defaultValue": [],
                        "metadata": {
                            "description": "Arrary of DNS Service IPs if wanting to use Custom DNS.  Ex: [\"10.10.1.1\",\"10.10.1.2\"]"
                        }
                    },
                    "subnets": {
                        "type": "Array",
                        "metadata": {
                            "description": "Names and address spaces of your Subnets.  Objects need a Name and Address Preffix property Ex: [{\"name\": \"subnet1\",\"addressPrefix\":\"10.10.0.0/24\"},{\"name\": \"subnet2\",\"addressPrefix\":\"10.10.1.0/24\"}]"
                        },
                        "defaultValue": []
                    },
                    "hubVnetId": {
                        "type": "String",
                        "metadata": {
                            "description": "Resource ID of the HUB VNET that the Spoke will be peered to. Ex: /subscriptions/<subId>/resourceGroups/Policy-Tset/providers/Microsoft.Network/virtualNetworks/<vnet name>"
                        }
                    },
                    "location": {
                        "type": "String",
                        "metadata": {
                            "description": "Azure Region that VNET will be deployed to. Ex: eastus"
                        }
                    }
                }
            }
        },
        "input3": {
            "value": {
                "mode": "All",
                "policyType": "Custom",
                "displayName": "Deploy-SitetoSite-VPN",
                "description": "Deploy A Site to Site VPN Connection.  Assing Policy to Resource Group that has you VPN Gateway that will be terminating the VPN Connection",
                "metadata": {
                    "category": "Enterprise Landing Zone"
                },
                "policyRule": {
                    "if": {
                        "field": "type",
                        "equals": "Microsoft.Resources/subscriptions"
                    },
                    "then": {
                        "effect": "deployIfNotExists",
                        "details": {
                            "type": "Microsoft.Network/connections",
                            "name": "[parameters('vpnConnectionName')]",
                            "ResourceGroupName": "[parameters('azureGatewayResourceGroupName')]",
                            "roleDefinitionIds": [
                                "/providers/Microsoft.Authorization/roleDefinitions/4d97b98b-1d4f-4787-a291-c67834d212e7"
                            ],
                            "existenceScope": "ResourceGroup",
                            "deploymentScope": "ResourceGroup",
                            "deployment": {
                                "properties": {
                                    "mode": "incremental",
                                    "parameters": {
                                        "vpnConnectionName": {
                                            "value": "[parameters('vpnConnectionName')]"
                                        },
                                        "remoteVpnPeerIp": {
                                            "value": "[parameters('remoteVpnPeerIp')]"
                                        },
                                        "remoteNetworks": {
                                            "value": "[parameters('remoteNetworks')]"
                                        },
                                        "connectionProtocol": {
                                            "value": "[parameters('connectionProtocol')]"
                                        },
                                        "sharedKey": {
                                            "value": "[parameters('sharedKey')]"
                                        },
                                        "phase1Integrity": {
                                            "value": "[parameters('phase1Integrity')]"
                                        },
                                        "phase1Encryption": {
                                            "value": "[parameters('phase1Encryption')]"
                                        },
                                        "phase1DhGroup": {
                                            "value": "[parameters('phase1DhGroup')]"
                                        },
                                        "phase2Integrity": {
                                            "value": "[parameters('phase2Integrity')]"
                                        },
                                        "phase2Encryption": {
                                            "value": "[parameters('phase2Encryption')]"
                                        },
                                        "phase2PfsGroup": {
                                            "value": "[parameters('phase2PfsGroup')]"
                                        },
                                        "phase2LifeTimeSeconds": {
                                            "value": "[parameters('phase2LifeTimeSeconds')]"
                                        },
                                        "phase2LifeTimeKB": {
                                            "value": "[parameters('phase2LifeTimeKB')]"
                                        },
                                        "isPolicyBasedVPN": {
                                            "value": "[parameters('isPolicyBasedVPN')]"
                                        },
                                        "bgpPeerIp": {
                                            "value": "[parameters('bgpPeerIp')]"
                                        },
                                        "bgpAsn": {
                                            "value": "[parameters('bgpAsn')]"
                                        },
                                        "azureGatewayName": {
                                            "value": "[parameters('azureGatewayName')]"
                                        },
                                        "location": {
                                            "value": "[parameters('location')]"
                                        }
                                    },
                                    "template": {
                                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                        "contentVersion": "1.0.0.0",
                                        "parameters": {
                                            "vpnConnectionName": {
                                                "type": "string"
                                            },
                                            "remoteVpnPeerIp": {
                                                "type": "string"
                                            },
                                            "remoteNetworks": {
                                                "type": "string"
                                            },
                                            "connectionProtocol": {
                                                "type": "string",
                                                "allowedValues": [
                                                    "IKEv2",
                                                    "IKEv1"
                                                ],
                                                "defaultValue": "IKEv2"
                                            },
                                            "sharedKey": {
                                                "type": "string"
                                            },
                                            "phase1Integrity": {
                                                "type": "string",
                                                "allowedValues": [
                                                    "MD5",
                                                    "SHA1",
                                                    "SHA256",
                                                    "GCMAES128",
                                                    "GCMAES192",
                                                    "GCMAES256"
                                                ]
                                            },
                                            "phase1Encryption": {
                                                "type": "string",
                                                "allowedValues": [
                                                    "None",
                                                    "DES",
                                                    "DES3",
                                                    "AES128",
                                                    "AES192",
                                                    "AES256",
                                                    "GCMAES128",
                                                    "GCMAES192",
                                                    "GCMAES256"
                                                ]
                                            },
                                            "phase1DhGroup": {
                                                "type": "string",
                                                "allowedValues": [
                                                    "None",
                                                    "DHGroup1",
                                                    "DHGroup2",
                                                    "DHGroup14",
                                                    "DHGroup2048",
                                                    "ECP256",
                                                    "ECP384",
                                                    "DHGroup24"
                                                ]
                                            },
                                            "phase2Integrity": {
                                                "type": "string",
                                                "allowedValues": [
                                                    "MD5",
                                                    "SHA1",
                                                    "SHA256",
                                                    "SHA384",
                                                    "GCMAES256",
                                                    "GCMAES128"
                                                ]
                                            },
                                            "phase2Encryption": {
                                                "type": "string",
                                                "allowedValues": [
                                                    "DES",
                                                    "DES3",
                                                    "AES128",
                                                    "AES192",
                                                    "AES256",
                                                    "GCMAES256",
                                                    "GCMAES128"
                                                ]
                                            },
                                            "phase2PfsGroup": {
                                                "type": "string",
                                                "allowedValues": [
                                                    "None",
                                                    "PFS1",
                                                    "PFS2",
                                                    "PFS2048",
                                                    "ECP256",
                                                    "ECP384",
                                                    "PFS24",
                                                    "PFS14",
                                                    "PFSMM"
                                                ]
                                            },
                                            "phase2LifeTimeSeconds": {
                                                "type": "int"
                                            },
                                            "phase2LifeTimeKB": {
                                                "type": "int"
                                            },
                                            "isPolicyBasedVPN": {
                                                "type": "bool"
                                            },
                                            "bgpPeerIp": {
                                                "type": "string"
                                            },
                                            "bgpAsn": {
                                                "type": "string"
                                            },
                                            "azureGatewayName": {
                                                "type": "string"
                                            },
                                            "location": {
                                                "type": "string"
                                            }
                                        },
                                        "variables": {
                                            "localNetworkGatewayPropertiesBgp": {
                                                "localNetworkAddressSpace": {
                                                    "addressPrefixes": "[split(parameters('remoteNetworks'),',')]"
                                                },
                                                "gatewayIpAddress": "[parameters('remoteVpnPeerIp')]",
                                                "bgpSettings": {
                                                    "asn": "[parameters('bgpAsn')]",
                                                    "bgpPeeringAddress": "[parameters('bgpPeerIp')]"
                                                }
                                            },
                                            "localNetworkGatewayProperties": {
                                                "localNetworkAddressSpace": {
                                                    "addressPrefixes": "[split(parameters('remoteNetworks'),',')]"
                                                },
                                                "gatewayIpAddress": "[parameters('remoteVpnPeerIp')]"
                                            },
                                            "emptyObject": {},
                                            "virtualNetworkGatewayId": "[concat(resourceGroup().id,'/providers/Microsoft.Network/virtualNetworkGateways/',parameters('azureGatewayName'))]",
                                            "ipsecPolicy": {
                                                "saLifeTimeSeconds": "[parameters('phase2LifeTimeSeconds')]",
                                                "saDataSizeKilobytes": "[parameters('phase2LifeTimeKB')]",
                                                "ipsecEncryption": "[parameters('phase1Encryption')]",
                                                "ipsecIntegrity": "[parameters('phase1Integrity')]",
                                                "ikeEncryption": "[parameters('phase2Encryption')]",
                                                "ikeIntegrity": "[parameters('phase2Integrity')]",
                                                "dhGroup": "[parameters('phase1DhGroup')]",
                                                "pfsGroup": "[parameters('phase2PfsGroup')]"
                                            }
                                        },
                                        "resources": [
                                            {
                                                "name": "[concat(parameters('vpnConnectionName'),'-localgw')]",
                                                "type": "Microsoft.Network/localNetworkGateways",
                                                "apiVersion": "2020-05-01",
                                                "location": "[parameters('location')]",
                                                "tags": {},
                                                "properties": "[if(and(not(empty(parameters('bgpPeerIp'))),not(empty(parameters('bgpAsn')))),variables('localNetworkGatewayPropertiesBgp'),variables('localNetworkGatewayProperties'))]"
                                            },
                                            {
                                                "name": "[parameters('vpnConnectionName')]",
                                                "type": "Microsoft.Network/connections",
                                                "apiVersion": "2020-05-01",
                                                "location": "[parameters('location')]",
                                                "dependsOn": [
                                                    "[concat(parameters('vpnConnectionName'),'-localgw')]"
                                                ],
                                                "tags": {},
                                                "properties": {
                                                    "virtualNetworkGateway1": {
                                                        "id": "[variables('virtualNetworkGatewayId')]"
                                                    },
                                                    "localNetworkGateway2": {
                                                        "id": "[resourceId('Microsoft.Network/localNetworkGateways',concat(parameters('vpnConnectionName'),'-localgw'))]"
                                                    },
                                                    "connectionType": "IPsec",
                                                    "connectionProtocol": "[parameters('connectionProtocol')]",
                                                    "sharedKey": "[parameters('sharedKey')]",
                                                    "usePolicyBasedTrafficSelectors": "[parameters('isPolicyBasedVPN')]",
                                                    "ipsecPolicies": [
                                                        "[variables('ipsecPolicy')]"
                                                    ],
                                                    "enableBgp": "[if(and(not(empty(parameters('bgpPeerIp'))),not(empty(parameters('bgpAsn')))),bool('true'),bool('false'))]"
                                                }
                                            }
                                        ],
                                        "outputs": {
                                            "test": {
                                                "type": "object",
                                                "value": "[if(and(not(empty(parameters('bgpPeerIp'))),not(empty(parameters('bgpAsn')))),variables('localNetworkGatewayPropertiesBgp'),variables('localNetworkGatewayProperties'))]"
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                },
                "parameters":{
                    "vpnConnectionName": {
                        "type": "string",
                        "metadata":{
                            "description": "Name of Azure Connection Object"
                        }
                    },
                    "remoteVpnPeerIp": {
                        "type": "string",
                        "metadata":{
                            "description": "Peer IP of remote Gateway to build VPN Connection"
                        }
                    },
                    "remoteNetworks": {
                        "type": "string",
                        "metadata":{
                            "description": "Comma seperated address prefixes that represents the remote networks.  Ex: \"172.16.0.0/24,172.16.1.0/24\""
                        }
                    },
                    "connectionProtocol": {
                        "type": "string",
                        "metadata":{
                            "description": "IKE Version, IKEv1 or IKEv2"
                        },
                        "allowedValues": [
                            "IKEv2",
                            "IKEv1"
                        ],
                        "defaultValue": "IKEv2"
                    },
                    "sharedKey": {
                        "type": "string",
                        "metadata":{
                            "description": "Preshared Key for VPN Connection"
                        }
                    },
                    "phase1Integrity": {
                        "type": "string",
                        "metadata":{
                            "description": "Phase 1 Integrity"
                        },
                        "allowedValues": [
                            "MD5",
                            "SHA1",
                            "SHA256",
                            "GCMAES128",
                            "GCMAES192",
                            "GCMAES256"
                        ]
                    },
                    "phase1Encryption": {
                        "type": "string",
                        "metadata":{
                            "description": "Phase 1 Encryption"
                        },
                        "allowedValues": [
                            "None",
                            "DES",
                            "DES3",
                            "AES128",
                            "AES192",
                            "AES256",
                            "GCMAES128",
                            "GCMAES192",
                            "GCMAES256"
                        ]
                    },
                    "phase1DhGroup": {
                        "type": "string",
                        "metadata":{
                            "description": "Phase 1 DH Group"
                        },
                        "allowedValues": [
                            "None",
                            "DHGroup1",
                            "DHGroup2",
                            "DHGroup14",
                            "DHGroup2048",
                            "ECP256",
                            "ECP384",
                            "DHGroup24"
                        ]
                    },
                    "phase2Integrity": {
                        "type": "string",
                        "metadata":{
                            "description": "Phase 2 Integrity"
                        },
                        "allowedValues": [
                            "MD5",
                            "SHA1",
                            "SHA256",
                            "SHA384",
                            "GCMAES256",
                            "GCMAES128"
                        ]
                    },
                    "phase2Encryption": {
                        "type": "string",
                        "metadata":{
                            "description": "Phase 2 Encryption"
                        },
                        "allowedValues": [
                            "DES",
                            "DES3",
                            "AES128",
                            "AES192",
                            "AES256",
                            "GCMAES256",
                            "GCMAES128"
                        ]
                    },
                    "phase2PfsGroup": {
                        "type": "string",
                        "metadata":{
                            "description": "Phase 2 PFS Group"
                        },
                        "allowedValues": [
                            "None",
                            "PFS1",
                            "PFS2",
                            "PFS2048",
                            "ECP256",
                            "ECP384",
                            "PFS24",
                            "PFS14",
                            "PFSMM"
                        ]
                    },
                    "phase2LifeTimeSeconds": {
                        "type": "integer",
                        "metadata":{
                            "description": "Phase 2 Lifetime in Seconds"
                        },
                        "defaultValue": 27000
                    },
                    "phase2LifeTimeKB": {
                        "type": "integer",
                        "metadata":{
                            "description": "Phase 2 Lifetime in KB"
                        },
                        "defaultValue": 102400000
                    },
                    "isPolicyBasedVPN": {
                        "type": "boolean",
                        "defaultValue": false,
                        "metadata":{
                            "description": "If the VPN will be a Policy Based connection."
                        }
                    },
                    "bgpPeerIp": {
                        "type": "string",
                        "metadata":{
                            "description": "Remote BGP Peer IP.  If not using BGP leave blank.  BGP is not an Option on Policy VPNs"
                        }
                    },
                    "bgpAsn": {
                        "type": "string",
                        "metadata":{
                            "description": "Remote BGP ASN.  If not using BGP leave blank.  BGP is not an Option on Policy VPNs"
                        }
                    },
                    "azureGatewayName": {
                        "type": "string",
                        "metadata":{
                            "description": "Name of Azure VPN Gateway."
                        }
                    },
                    "azureGatewayResourceGroupName": {
                        "type": "string",
                        "metadata":{
                            "description": "Name of Azure VPN Gateway Resource Group."
                        }
                    },
                    "location": {
                        "type": "string",
                        "metadata":{
                            "description": "Azure Region for Azure VPN Gateway"
                        }
                    }
                }
            }
        }
    }
}